<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Street View Side-By-Side</title>
  <style>
    #map,
    #pano {
      /* float: left; */
      height: 400px;
      width: 100%;
    }
  </style>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
    integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">

  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
    integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
    crossorigin="anonymous"></script>
</head>

<body>
  <div class="modal fade" id="myModal" data-backdrop="static" data-keyboard="false" tabindex="-1" role="dialog"
    aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="staticBackdropLabel">GeoHunt (Prototype)</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <p>Welcome to GeoHunt, an online scavenger game.</p>

          <p>With the clues you're given, move "pegman" to the target. When you think you are there, click <span>I found
              it</span> button. Do it fast, as you are losing points EVERY second. The faster you find the location, the
            more points you keep. However, if you got it wrong (or not close enough) you get points taken away! </p>

          <p>You can drag Pegman around the map, and both streetview and the map will follow. You MUST drag
            pegman himself. I measure distance of pegman to the target to determine if you're close enough.</p>


        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" data-dismiss="modal" onClick=initGame()>Let's Go!</button>
        </div>
      </div>
    </div>
  </div>

  <div class="container-fluid">
    <h2>GeoHunt Prototype</h2>
    <p>A virtual geographical hunt for targets around the city. (Target is Twin Peaks)</p>
  </div>
  <div class="container-fluid">
    <div class="row">
      <div class="col">
        <div class="row" id="map"></div>
        <div class="row" id="pano"></div>
      </div>
      <div class="col">
        <div class="form-group">
          <label for="curScore">Your Current Score: </label>
          <input type="text" id="curScore" />
        </div>

        <h3>Hints go here</h3>

        <button type="button" class="btn btn-danger" onclick=isCloseEnough()>I am here (I think)</button>

        <button type="button" class="btn btn-info" onclick=calcDistance()>Distance</button>

        <button type="button" class="btn btn-info" onclick=calcBearing()>Bearing</button>
      </div>
    </div>
  </div>

  <script>
    const startScore = 1000;
    const penalty = 100;
    const persecond = 3;
    var curScore = startScore
    var myInterval
    const twinPeaks = {
      lat: 37.7542,
      lng: -122.4471
    };

    var huntTarget = twinPeaks;

    function perTick() {
      curScore -= persecond;
      $("#curScore").val(curScore);
      if (curScore <= 0) {
        ranOutfTime();
      }
    }

    function initGame() {
      $("#curScore").val(curScore)
      initTick();
    }

    function initTick() {
      myInterval = setInterval(perTick, 1000)
    }

    function clearTick() {
      clearInterval(myInterval)
    }

    function ranOutfTime() {
      clearTick();
      alert("Sorry, you ran out of time. Your score is ZERO. Hit RELOAD/REFRESH to try again.")
    }

    function isCloseEnough() {
      if (haversine_distance(curCenter, huntTarget) < 0.01) {
        //you found it!!!!!  stop the clock
        clearTick();
        alert("YOU FOUND IT! Your score is " + curScore)
      } else {
        // wah wah wah...
        alert("Sorry, you're not close enough!")
        curScore -= penalty
        if (curScore < 0) {
          ranOutfTime();
        }
      }
    }

    function calcBearing() {

      start_latitude = curCenter.lat
      start_longitude = curCenter.lng
      stop_latitude = huntTarget.lat
      stop_longitude = huntTarget.lng

      var y = Math.sin(stop_longitude - start_longitude) * Math.cos(stop_latitude);
      var x = Math.cos(start_latitude) * Math.sin(stop_latitude) -
        Math.sin(start_latitude) * Math.cos(stop_latitude) * Math.cos(stop_longitude - start_longitude);
      var brng = Math.atan2(y, x) * 180 / Math.PI;
      // return brng
      if (brng < 0) {
        brng += 360
      }

      console.log(brng)
      alert("Brng = " + brng)

    }

    function haversine_distance(mk1, mk2) {
      var R = 3958.8; // Radius of the Earth in miles
      var rlat1 = mk1.lat * (Math.PI / 180); // Convert degrees to radians
      var rlat2 = mk2.lat * (Math.PI / 180); // Convert degrees to radians
      var difflat = rlat2 - rlat1; // Radian difference (latitudes)
      var difflon = (mk2.lng - mk1.lng) * (Math.PI / 180); // Radian difference (longitudes)

      var d = 2 * R * Math.asin(Math.sqrt(Math.sin(difflat / 2) * Math.sin(difflat / 2) + Math.cos(rlat1) * Math.cos(rlat2) * Math.sin(difflon / 2) * Math.sin(difflon / 2)));
      return d;
    }

    const sf = { lat: 37.7749, lng: -122.4194 };
    var curCenter = sf

    function calcDistance() {
      // const p1 = LatLon.parse(curCenter.lat + "," + curCenter.lng)
      // const p2 = LatLon.parse(twinPeaks.lat + "," + twinPeaks.lng)
      // console.log(curCenter)
      var dist = haversine_distance(curCenter, twinPeaks)
      console.log(dist)
      alert("Dist = " + dist)
    }

    function initialize() {
      // var mapOptions = { disableDefaultUI: true}
      // var sf = { lat: 37.7749, lng: -122.4194 };
      var map = new google.maps.Map(document.getElementById('map'), {
        center: sf,
        zoom: 16,
        panControl: false,
        zoomControl: false,
        mapTypeControl: false,
        scaleControl: false,
        streetViewControl: true,
        overviewMapControl: false,
        rotateControl: false
      });
      var panorama = new google.maps.StreetViewPanorama(
        document.getElementById('pano'), {
        position: sf,
        pov: {
          heading: 0,
          pitch: 0
        }
      });
      map.setStreetView(panorama);
      panorama.addListener('position_changed', function () {
        map.setCenter(panorama.getPosition());
        curCenter = map.getCenter().toJSON();
      });
    }
  </script>
  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAUFRV2Qv6kYtvjmASK8HOve2VBWRAc9N8&callback=initialize"> </script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
    integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
    crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"
    integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI"
    crossorigin="anonymous"></script>
  <script>
    $(window).on('load', function () {
      //display the "intro" modal
      $('#myModal').modal('show');

    });
  </script>
</body>

</html>